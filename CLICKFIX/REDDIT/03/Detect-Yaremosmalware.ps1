Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Red
Write-Host "â•‘  Yaremos Malware Detection Script - Complete System Scan    â•‘" -ForegroundColor Red
Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Red
Write-Host ""

$findings = @{
    DiscordInjection = @()
    ScheduledTasks = @()
    RegistryKeys = @()
    FileMasquerading = @()
    UACBypass = @()
    SuspiciousProcesses = @()
    NetworkConnections = @()
}

# 1. Check Discord Injection
Write-Host "[1/7] Checking for Discord core.asar injection..." -ForegroundColor Cyan
$discordPaths = @(
    "$env:LOCALAPPDATA\Discord",
    "$env:LOCALAPPDATA\DiscordCanary",
    "$env:LOCALAPPDATA\DiscordPTB"
)

foreach ($path in $discordPaths) {
    if (Test-Path $path) {
        Get-ChildItem -Path $path -Recurse -Filter "core.asar" -ErrorAction SilentlyContinue | 
            ForEach-Object {
                $age = (Get-Date) - $_.LastWriteTime
                if ($age.TotalDays -lt 30) {
                    $findings.DiscordInjection += [PSCustomObject]@{
                        Path = $_.FullName
                        Modified = $_.LastWriteTime
                        Size = $_.Length
                        DaysSinceModification = [math]::Round($age.TotalDays, 1)
                    }
                    Write-Host "    [!] SUSPICIOUS: $($_.FullName)" -ForegroundColor Red
                    Write-Host "        Modified: $($_.LastWriteTime) ($([math]::Round($age.TotalDays, 1)) days ago)" -ForegroundColor Red
                }
            }
    }
}

# 2. Check Scheduled Tasks
Write-Host "[2/7] Checking for malicious scheduled tasks..." -ForegroundColor Cyan
$tasks = Get-ScheduledTask | Where-Object {
    $_.Settings.Hidden -eq $true -or 
    $_.Description -like "*autochk*" -or
    $_.Description -like "*telemetry*" -or
    $_.Description -like "*sync*"
}

foreach ($task in $tasks) {
    $findings.ScheduledTasks += $task
    Write-Host "    [!] FOUND: $($task.TaskName)" -ForegroundColor Red
}

# 3. Check Registry
Write-Host "[3/7] Checking registry run keys..." -ForegroundColor Cyan
$runKeys = @(
    "HKCU:\Software\Microsoft\Windows\CurrentVersion\Run",
    "HKCU:\Software\Microsoft\Windows\CurrentVersion\RunOnce"
)

foreach ($key in $runKeys) {
    if (Test-Path $key) {
        $values = Get-ItemProperty $key -ErrorAction SilentlyContinue
        $values.PSObject.Properties | Where-Object {
            $_.Name -notmatch "PS" -and $_.Value -ne $null
        } | ForEach-Object {
            $findings.RegistryKeys += [PSCustomObject]@{
                Key = $key
                Name = $_.Name
                Value = $_.Value
            }
            Write-Host "    [!] FOUND: $($_.Name)" -ForegroundColor Yellow
        }
    }
}

# 4. Check File Masquerading
Write-Host "[4/7] Checking for file masquerading..." -ForegroundColor Cyan
$systemCache = "$env:LOCALAPPDATA\Microsoft\Windows\SystemCache"
if (Test-Path $systemCache) {
    Write-Host "    [!] ALERT: SystemCache folder exists!" -ForegroundColor Red
    Get-ChildItem $systemCache -Force -ErrorAction SilentlyContinue | ForEach-Object {
        $findings.FileMasquerading += $_
        Write-Host "        $($_.Name)" -ForegroundColor Red
    }
}

# 5. Check UAC Bypass
Write-Host "[5/7] Checking for UAC bypass artifacts..." -ForegroundColor Cyan
$uacKeys = @(
    "HKCU:\Software\Classes\ms-settings\shell\open\command",
    "HKCU:\Software\Classes\mscfile\shell\open\command",
    "HKCU:\Software\Classes\Folder\shell\open\command",
    "HKCU:\Software\Classes\exefile\shell\runas\command"
)

foreach ($key in $uacKeys) {
    if (Test-Path $key) {
        $findings.UACBypass += $key
        Write-Host "    [!] UAC BYPASS KEY: $key" -ForegroundColor Red
    }
}

# 6. Check Processes
Write-Host "[6/7] Checking for suspicious processes..." -ForegroundColor Cyan
$processes = Get-Process | Where-Object {
    ($_.ProcessName -like "*node*" -or $_.ProcessName -like "*python*") -and
    ($_.Path -like "*AppData*" -or $_.Path -like "*Temp*" -or $_.Path -like "*SystemCache*")
}

foreach ($proc in $processes) {
    $findings.SuspiciousProcesses += $proc
    Write-Host "    [!] SUSPICIOUS: $($proc.ProcessName) (PID: $($proc.Id))" -ForegroundColor Red
    Write-Host "        Path: $($proc.Path)" -ForegroundColor Red
}

# 7. Check Network
Write-Host "[7/7] Checking network connections..." -ForegroundColor Cyan
$c2Domains = @("network-sync-protocol.net", "datanetworksync.onrender.com", "gofile.io")
$netstat = netstat -ano | Out-String

foreach ($domain in $c2Domains) {
    if ($netstat -match $domain) {
        $findings.NetworkConnections += $domain
        Write-Host "    [!] C2 CONNECTION: $domain" -ForegroundColor Red
    }
}

# Summary
Write-Host "`nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Cyan
Write-Host "â•‘                    DETECTION SUMMARY                         â•‘" -ForegroundColor Cyan
Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
Write-Host ""

$threatLevel = "CLEAN"
$totalFindings = 0

$totalFindings += $findings.DiscordInjection.Count
$totalFindings += $findings.ScheduledTasks.Count
$totalFindings += $findings.RegistryKeys.Count
$totalFindings += $findings.FileMasquerading.Count
$totalFindings += $findings.UACBypass.Count
$totalFindings += $findings.SuspiciousProcesses.Count
$totalFindings += $findings.NetworkConnections.Count

if ($totalFindings -gt 0) {
    $threatLevel = if ($findings.DiscordInjection.Count -gt 0 -or $findings.NetworkConnections.Count -gt 0) {
        "CRITICAL"
    } elseif ($findings.ScheduledTasks.Count -gt 0 -or $findings.FileMasquerading.Count -gt 0) {
        "HIGH"
    } else {
        "MEDIUM"
    }
}

Write-Host "Threat Level: " -NoNewline
switch ($threatLevel) {
    "CRITICAL" { Write-Host "ğŸ”´ CRITICAL - ACTIVE INFECTION DETECTED" -ForegroundColor Red }
    "HIGH" { Write-Host "ğŸŸ  HIGH - INFECTION LIKELY" -ForegroundColor Red }
    "MEDIUM" { Write-Host "ğŸŸ¡ MEDIUM - SUSPICIOUS ACTIVITY" -ForegroundColor Yellow }
    "CLEAN" { Write-Host "ğŸŸ¢ CLEAN - NO THREATS DETECTED" -ForegroundColor Green }
}

Write-Host ""
Write-Host "Findings:" -ForegroundColor Cyan
Write-Host "  Discord Injection:     $($findings.DiscordInjection.Count)" -ForegroundColor $(if ($findings.DiscordInjection.Count -gt 0) { "Red" } else { "Green" })
Write-Host "  Scheduled Tasks:       $($findings.ScheduledTasks.Count)" -ForegroundColor $(if ($findings.ScheduledTasks.Count -gt 0) { "Red" } else { "Green" })
Write-Host "  Registry Keys:         $($findings.RegistryKeys.Count)" -ForegroundColor $(if ($findings.RegistryKeys.Count -gt 0) { "Yellow" } else { "Green" })
Write-Host "  File Masquerading:     $($findings.FileMasquerading.Count)" -ForegroundColor $(if ($findings.FileMasquerading.Count -gt 0) { "Red" } else { "Green" })
Write-Host "  UAC Bypass:            $($findings.UACBypass.Count)" -ForegroundColor $(if ($findings.UACBypass.Count -gt 0) { "Red" } else { "Green" })
Write-Host "  Suspicious Processes:  $($findings.SuspiciousProcesses.Count)" -ForegroundColor $(if ($findings.SuspiciousProcesses.Count -gt 0) { "Red" } else { "Green" })
Write-Host "  C2 Connections:        $($findings.NetworkConnections.Count)" -ForegroundColor $(if ($findings.NetworkConnections.Count -gt 0) { "Red" } else { "Green" })
Write-Host ""

if ($threatLevel -ne "CLEAN") {
    Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Red
    Write-Host "â•‘                  âš ï¸  IMMEDIATE ACTIONS âš ï¸                    â•‘" -ForegroundColor Red
    Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Red
    Write-Host ""
    Write-Host "1. DISCONNECT FROM INTERNET IMMEDIATELY" -ForegroundColor Red
    Write-Host "2. Run the remediation script" -ForegroundColor Red
    Write-Host "3. Change ALL passwords from a clean device" -ForegroundColor Red
    Write-Host "4. Revoke Discord/Roblox/Steam sessions" -ForegroundColor Red
    Write-Host "5. Monitor financial accounts" -ForegroundColor Red
    Write-Host ""
}

# Export report
$reportPath = "$env:USERPROFILE\Desktop\YaremosMalwareDetection_$(Get-Date -Format 'yyyyMMdd_HHmmss').json"
$findings | ConvertTo-Json -Depth 10 | Out-File $reportPath
Write-Host "[+] Report saved to: $reportPath" -ForegroundColor Green
